{% extends 'ovpn_app/base.html' %}

{% block title %}{% if form.instance.pk %}Редактировать{% else %}Добавить{% endif %} сервер - OpenVPN Control Panel{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">{% if form.instance.pk %}Редактировать{% else %}Добавить{% endif %} сервер OpenVPN</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="{% url 'ovpn_app:server_list' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Назад к списку
            </a>
        </div>
    </div>
</div>

{% if form.errors %}
    <div class="alert alert-danger">
        <h6>Пожалуйста, исправьте следующие ошибки:</h6>
        <ul>
            {% for field, errors in form.errors.items %}
                {% for error in errors %}
                    <li><strong>{{ field }}:</strong> {{ error }}</li>
                {% endfor %}
            {% endfor %}
        </ul>
    </div>
{% endif %}

<div class="row">
    <div class="col-lg-8">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Параметры сервера</h6>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}

                    <h5>Основные настройки</h5>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="{{ form.name.id_for_label }}" class="form-label">{{ form.name.label }}</label>
                            {{ form.name }}
                        </div>
                        <div class="col-md-6">
                            <label for="{{ form.host.id_for_label }}" class="form-label">{{ form.host.label }}</label>
                            {{ form.host }}
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.description.id_for_label }}" class="form-label">{{ form.description.label }}</label>
                        {{ form.description }}
                    </div>

                    <hr>
                    <h5>Подключение к серверу</h5>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="{{ form.ssh_username.id_for_label }}" class="form-label">{{ form.ssh_username.label }}</label>
                            {{ form.ssh_username }}
                        </div>
                        <div class="col-md-6">
                            <label for="{{ form.ssh_port.id_for_label }}" class="form-label">{{ form.ssh_port.label }}</label>
                            {{ form.ssh_port }}
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="{{ form.ssh_password.id_for_label }}" class="form-label">{{ form.ssh_password.label }}</label>
                            {{ form.ssh_password }}
                            <div class="form-text">Можно указать пароль или SSH ключ</div>
                        </div>
                        <div class="col-md-6">
                            <label for="{{ form.ssh_key_path.id_for_label }}" class="form-label">{{ form.ssh_key_path.label }}</label>
                            {{ form.ssh_key_path }}
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.ssh_private_key.id_for_label }}" class="form-label">{{ form.ssh_private_key.label }}</label>
                        {{ form.ssh_private_key }}
                        <div class="form-text">Приватный SSH ключ для аутентификации (альтернатива паролю)</div>
                    </div>

                    <hr>
                    <h5>Настройки OpenVPN</h5>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="{{ form.openvpn_port.id_for_label }}" class="form-label">{{ form.openvpn_port.label }}</label>
                            {{ form.openvpn_port }}
                        </div>
                        <div class="col-md-4">
                            <label for="{{ form.openvpn_protocol.id_for_label }}" class="form-label">{{ form.openvpn_protocol.label }}</label>
                            {{ form.openvpn_protocol }}
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="{{ form.server_subnet.id_for_label }}" class="form-label">{{ form.server_subnet.label }}</label>
                            {{ form.server_subnet }}
                        </div>
                        <div class="col-md-6">
                            <label for="{{ form.server_netmask.id_for_label }}" class="form-label">{{ form.server_netmask.label }}</label>
                            {{ form.server_netmask }}
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="{{ form.dns1.id_for_label }}" class="form-label">{{ form.dns1.label }}</label>
                            {{ form.dns1 }}
                            <div class="form-text">Первичный DNS сервер</div>
                        </div>
                        <div class="col-md-6">
                            <label for="{{ form.dns2.id_for_label }}" class="form-label">{{ form.dns2.label }}</label>
                            {{ form.dns2 }}
                            <div class="form-text">Вторичный DNS сервер</div>
                        </div>
                    </div>

                    <hr>
                    <h5>STunnel (обход блокировок)</h5>

                    <div class="alert alert-warning" id="stunnelWarning" style="display: none;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>STunnel работает только с TCP!</strong> Измените протокол на TCP, чтобы включить STunnel.
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-check">
                                {{ form.use_stunnel }}
                                <label class="form-check-label" for="{{ form.use_stunnel.id_for_label }}">
                                    {{ form.use_stunnel.label }}
                                </label>
                            </div>
                            <div class="form-text">Включить STunnel для маскировки под HTTPS трафик (только для TCP)</div>
                        </div>
                        <div class="col-md-6">
                            <label for="{{ form.stunnel_port.id_for_label }}" class="form-label">{{ form.stunnel_port.label }}</label>
                            {{ form.stunnel_port }}
                            <div class="form-text">Порт для STunnel (обычно 443)</div>
                        </div>
                    </div>

                    <hr>                    <div class="d-flex justify-content-between">
                        <a href="{% url 'ovpn_app:server_list' %}" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Отмена
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> {% if form.instance.pk %}Обновить{% else %}Сохранить{% endif %} сервер
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-info">Справка</h6>
            </div>
            <div class="card-body">
                <h6>Подключение к серверу</h6>
                <p class="small text-muted">
                    Укажите данные для SSH подключения к серверу.
                    Можно использовать пароль или SSH ключ.
                </p>

                <h6>Настройки OpenVPN</h6>
                <p class="small text-muted">
                    Порт и протокол для OpenVPN сервера.
                    Подсеть для VPN клиентов в формате 10.8.0.0.
                </p>

                <div class="alert alert-info">
                    <small>
                        <i class="fas fa-info-circle"></i>
                        После добавления сервера вы сможете установить на него OpenVPN.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.form-control, .form-select {
    margin-bottom: 0.5rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const protocolSelect = document.getElementById('{{ form.openvpn_protocol.id_for_label }}');
    const stunnelCheckbox = document.getElementById('{{ form.use_stunnel.id_for_label }}');
    const stunnelPortInput = document.getElementById('{{ form.stunnel_port.id_for_label }}');
    const stunnelWarning = document.getElementById('stunnelWarning');

    function updateStunnelAvailability() {
        const protocol = protocolSelect.value;
        const isTCP = protocol === 'tcp';

        if (!isTCP) {
            // UDP выбран - отключаем STunnel
            stunnelCheckbox.disabled = true;
            stunnelCheckbox.checked = false;
            stunnelPortInput.disabled = true;
            stunnelWarning.style.display = 'block';
        } else {
            // TCP выбран - включаем STunnel
            stunnelCheckbox.disabled = false;
            stunnelPortInput.disabled = false;
            stunnelWarning.style.display = 'none';
        }
    }

    // Проверяем при загрузке страницы
    updateStunnelAvailability();

    // Проверяем при изменении протокола
    protocolSelect.addEventListener('change', updateStunnelAvailability);
});
</script>

{% endblock %}
